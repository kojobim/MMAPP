<?xml version="1.0" encoding="UTF-8"?>
<proxy name="InversionesDetalleProxy" startOnLoad="true" transports="http https" xmlns="http://ws.apache.org/ns/synapse">
    <target>
        <inSequence>
            <!-- Payload de llamada al stored procedure NBSALCEDCON -->
            <!-- Payload para llamar al stored procedure NBINVERSCON -->
            <!-- Payload de respuesta -->
            <log level="full"/>
            <!-- Obtencion de parametros -->
            <property expression="json-eval($.InversionesDetalleProxy.numTransac)" name="numTransac" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesDetalleProxy.usuario)" name="usuario" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesDetalleProxy.bitUsuari)" name="bitUsuari" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesDetalleProxy.bitMonto)" name="bitMonto" scope="default" type="DOUBLE"/>
            <property expression="json-eval($.InversionesDetalleProxy.invClient)" name="invClient" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesDetalleProxy.invMoneda)" name="invMoneda" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesDetalleProxy.invUsuari)" name="invUsuari" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesDetalleProxy.invNumero)" name="invNumero" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesDetalleProxy.categoria)" name="categoria" scope="default" type="STRING"/>
            <!-- Declaracion y asignacion de constantes -->
            <property name="tipConsul" scope="default" type="STRING" value="L1"/>
            <property name="sucOrigen" scope="default" type="STRING" value="001"/>
            <property name="sucDestino" scope="default" type="STRING" value="001"/>
            <property name="modulo" scope="default" type="STRING" value="NB"/>
            <property name="transaccio" scope="default" type="STRING" value="HKQ"/>
            <property name="bitTipOpe" scope="default" type="STRING" value="004"/>
            <property name="bitPriRef" scope="default" type="STRING" value="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36"/>
            <property expression="get-property('SYSTEM_DATE', 'yyyy-MM-dd HH:mm:ss')" name="fechaSis" scope="default" type="STRING"/>
            <property expression="get-property('axis2','REMOTE_ADDR')" name="bitDireIP" scope="default" type="STRING"/>
            <!-- Obtencion del Payload original -->
            <enrich>
                <source clone="true" type="body"/>
                <target property="PAYLOAD_ORIGINAL" type="property"/>
            </enrich>
            <log level="custom">
                <property expression="get-property('PAYLOAD_ORIGINAL')" name="Payload Original..."/>
                <property expression="json-eval($.)" name="Payload Respuesta..."/>
            </log>
            <!-- Payload para llamar al stored procedure NBBITACOALT -->
            <payloadFactory media-type="json">
                <format>
                {
                	"bitacoraCreacionOp": {
                		"Bit_Usuari": "$1",
                		"Bit_Fecha": "$2",
                		"Bit_NumTra": "",
                		"Bit_TipOpe": "$3",
                		"Bit_CueOri": "",
                		"Bit_CueDes": "",
                		"Bit_Monto": $4,
                		"Bit_PriRef": "$5",
                		"Bit_SegRef": "",
                		"Bit_DireIP": "$6",
                		"NumTransac": "$7",
                		"Transaccio": "$8",
                		"Usuario": "$9",
                		"FechaSis": "$10",
                		"SucOrigen": "$11",
                		"SucDestino": "$12",
                		"Modulo": "$13"
                	}
                }
                </format>
                <args>
                    <arg evaluator="xml" expression="$ctx:bitUsuari"/>
                    <arg evaluator="xml" expression="$ctx:fechaSis"/>
                    <arg evaluator="xml" expression="$ctx:bitTipOpe"/>
                    <arg evaluator="xml" expression="$ctx:bitMonto"/>
                    <arg evaluator="xml" expression="$ctx:bitPriRef"/>
                    <arg evaluator="xml" expression="$ctx:bitDireIP"/>
                    <arg evaluator="xml" expression="$ctx:numTransac"/>
                    <arg evaluator="xml" expression="$ctx:transaccio"/>
                    <arg evaluator="xml" expression="$ctx:usuario"/>
                    <arg evaluator="xml" expression="$ctx:fechaSis"/>
                    <arg evaluator="xml" expression="$ctx:sucOrigen"/>
                    <arg evaluator="xml" expression="$ctx:sucDestino"/>
                    <arg evaluator="xml" expression="$ctx:modulo"/>
                </args>
            </payloadFactory>
            <call blocking="true">
                <endpoint>
                    <address uri="http://localhost:8280/services/BitacoraServicio/bitacoraCreacionOp"/>
                </endpoint>
            </call>
            <enrich>
                <source clone="true" type="body"/>
                <target property="PAYLOAD_PRIMERA_LLAMADA" type="property"/>
            </enrich>
            <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
                <then>
                    <log level="custom">
                        <property expression="get-property('PAYLOAD_PRIMERA_LLAMADA')" name="Payload de la primera llamada..."/>
                    </log>
                    <switch source="get-property('categoria')">
                        <case regex="PAGARE">
                            <payloadFactory media-type="json">
                                <format>
                                {
                                	"inversionesPagareNumeroUsuarioObtenerOp": {
                                		"Inv_Numero": "",
                                		"Inv_Usuari": "$1",
                                		"Tip_Consul": "$2",
                                		"NumTransac": "",
                                		"Transaccio": "$3",
                                		"Usuario": "$4",
                                		"FechaSis": "$5",
                                		"SucOrigen": "$6",
                                		"SucDestino": "$7",
                                		"Modulo": "$8"
                                	}
                                }
                                </format>
                                <args>
                                    <arg evaluator="xml" expression="$ctx:invUsuari"/>
                                    <arg evaluator="xml" expression="$ctx:tipConsul"/>
                                    <arg evaluator="xml" expression="$ctx:transaccio"/>
                                    <arg evaluator="xml" expression="$ctx:usuario"/>
                                    <arg evaluator="xml" expression="$ctx:fechaSis"/>
                                    <arg evaluator="xml" expression="$ctx:sucOrigen"/>
                                    <arg evaluator="xml" expression="$ctx:sucDestino"/>
                                    <arg evaluator="xml" expression="$ctx:modulo"/>
                                </args>
                            </payloadFactory>
                            <call>
                                <endpoint>
                                    <address uri="http://localhost:8280/services/InversionesServicio/inversionesPagareNumeroUsuarioObtenerOp"/>
                                </endpoint>
                            </call>
                            <enrich>
                                <source clone="true" type="body"/>
                                <target property="PAYLOAD_SEGUNDA_LLAMADA" type="property"/>
                            </enrich>
                            <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
                                <then>
                                    <log level="custom">
                                        <property expression="get-property('PAYLOAD_SEGUNDA_LLAMADA')" name="Payload de la segunda llamada..."/>
                                    </log>
                                    <!-- Recorremos el arreglo obtenido de la llamada anterior y filtramos por Inv_Numero -->
                                    <property name="contador" scope="operation" type="STRING" value="0"/>
                                    <property expression="count(//inversiones/inversion)" name="totalInv" scope="operation" type="STRING"/>
                                    <foreach expression="//inversiones/inversion">
                                        <sequence>
                                            <property expression="number(get-property('operation','contador') + 1)" name="contador" scope="operation" type="STRING"/>
                                            <filter xpath="//Inv_Numero = $ctx:invNumero">
                                                <then>
                                                    <payloadFactory media-type="json">
                                                        <format>
                                                        {
                                                        	"inversion": {
                                                        		"invFecIni": "$1",
                                                        		"invFecVen": "$2",
                                                        		"invCuenta": "$3",
                                                        		"invGat": "$4",
                                                        		"invGatRea": "$5",
                                                        		"plazo": "$6",
                                                        		"intBru": "$7",
                                                        		"invIntNet": "$8",
                                                        		"invISRTot": "$9",
                                                        		"invTotal": "$10",
                                                        		"cpRenInv": ""
                                                        	}
                                                        }
                                                        </format>
                                                        <args>
                                                            <arg evaluator="xml" expression="//Inv_FecIni/text()"/>
                                                            <arg evaluator="xml" expression="//Inv_FecVen/text()"/>
                                                            <arg evaluator="xml" expression="//Inv_Cuenta/text()"/>
                                                            <arg evaluator="xml" expression="//Inv_GAT"/>
                                                            <arg evaluator="xml" expression="//Inv_GATRea"/>
                                                            <arg evaluator="xml" expression="//Inv_Plazo"/>
                                                            <arg evaluator="xml" expression="//Inv_TBruta"/>
                                                            <arg evaluator="xml" expression="//Imp_Intere"/>
                                                            <arg evaluator="xml" expression="//Inv_ISR"/>
                                                            <arg evaluator="xml" expression="//Inv_Total"/>
                                                        </args>
                                                    </payloadFactory>
                                                    <!-- Llamamos al micro-servicio para calcular vencimiento y redondear propiedades -->
                                                    <call blocking="true">
                                                        <endpoint>
                                                            <http method="post" uri-template="http://localhost:9090/inversiones/detalle"/>
                                                        </endpoint>
                                                    </call>
                                                    <respond/>
                                                </then>
                                                <else>
                                                    <filter xpath="get-property('operation','contador') = get-property('operation','totalInv')">
                                                        <then>
                                                            <log level="custom">
                                                                <property name="switchlog" value="CASO: No se encontraron coincidencias..."/>
                                                            </log>
                                                            <!-- Payload en caso de numero de inversion no valido -->
                                                            <property name="HTTP_SC" scope="axis2" type="STRING" value="409"/>
                                                            <payloadFactory media-type="json">
                                                                <format>
                                                                {
                                                                	"Error": {
                                                                		"Err_Codigo": 409,
                                                                		"Err_Mensaj": "Numero de inversion invalido"
                                                                	}
                                                                }</format>
                                                                <args/>
                                                            </payloadFactory>
                                                            <respond/>
                                                        </then>
                                                        <else/>
                                                    </filter>
                                                </else>
                                            </filter>
                                        </sequence>
                                    </foreach>
                                </then>
                                <else>
                                    <log level="custom">
                                        <property name="switchlog" value="CASO: Error en la segunda llamada..."/>
                                    </log>
                                    <property name="HTTP_SC" scope="axis2" type="STRING" value="500"/>
                                    <payloadFactory media-type="json">
                                        <format>
                                        {
                                        	"Error": {
                                        		"Err_Codigo": 500,
                                        		"Err_Mensaj": "Error!"
                                        	}
                                        }
                                        </format>
                                        <args/>
                                    </payloadFactory>
                                    <respond/>
                                </else>
                            </filter>
                        </case>
                        <default>
                            <payloadFactory media-type="json">
                                <format>
                                {
                                	"inversionesObtenerOp": {
                                		"Inv_Client": "$1",
                                		"Inv_Moneda": "$2",
                                		"NumTransac": "",
                                		"Transaccio": "$3",
                                		"Usuario": "$4",
                                		"FechaSis": "$5",
                                		"SucOrigen": "$6",
                                		"SucDestino": "$7",
                                		"Modulo": "$8"
                                	}
                                }
                                </format>
                                <args>
                                    <arg evaluator="xml" expression="$ctx:invClient"/>
                                    <arg evaluator="xml" expression="$ctx:invMoneda"/>
                                    <arg evaluator="xml" expression="$ctx:transaccio"/>
                                    <arg evaluator="xml" expression="$ctx:usuario"/>
                                    <arg evaluator="xml" expression="$ctx:fechaSis"/>
                                    <arg evaluator="xml" expression="$ctx:sucOrigen"/>
                                    <arg evaluator="xml" expression="$ctx:sucDestino"/>
                                    <arg evaluator="xml" expression="$ctx:modulo"/>
                                </args>
                            </payloadFactory>
                            <call>
                                <endpoint>
                                    <address uri="http://localhost:8280/services/InversionesServicio/inversionesObtenerOp"/>
                                </endpoint>
                            </call>
                            <enrich>
                                <source clone="true" type="body"/>
                                <target property="PAYLOAD_SEGUNDA_LLAMADA" type="property"/>
                            </enrich>
                            <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
                                <then>
                                    <log level="custom">
                                        <property expression="get-property('PAYLOAD_SEGUNDA_LLAMADA')" name="Payload de la segunda llamada..."/>
                                    </log>
                                    <!-- Recorremos el arreglo obtenido de la llamada anterior y filtramos por Inv_Numero y Inv_Tipo -->
                                    <property name="contador" scope="operation" type="STRING" value="0"/>
                                    <property expression="count(//inversiones/inversion)" name="totalInv" scope="operation" type="STRING"/>
                                    <foreach expression="//inversiones/inversion">
                                        <sequence>
                                            <property expression="number(get-property('operation','contador') + 1)" name="contador" scope="operation" type="STRING"/>
                                            <filter xpath="//Inv_Numero = $ctx:invNumero and //Inv_Tipo = 'V'">
                                                <then>
                                                    <property expression="//Amo_Tasa" name="amoTasa" scope="operation" type="STRING"/>
                                                    <property expression="//Amo_ISR" name="amoISR" scope="operation" type="STRING"/>
                                                    <property expression="number(get-property('operation','amoISR') * 0.10) + number(get-property('operation','amoTasa'))" name="intBru" scope="operation" type="STRING"/>
                                                    <!-- Payload de respuesta -->
                                                    <payloadFactory media-type="json">
                                                        <format>
                                                        {
                                                        	"inversion": {
                                                        		"invFecIni": "$1",
                                                        		"invFecVen": "$2",
                                                        		"invCuenta": "$3",
                                                        		"invGat": "$4",
                                                        		"invGatRea": "$5",
                                                        		"plazo": "$6",
                                                        		"intBru": "$7",
                                                        		"invIntNet": "$8",
                                                        		"invISRTot": "$9",
                                                        		"invTotal": "$10",
                                                        		"cpRenInv": ""
                                                        	}
                                                        }
                                                        </format>
                                                        <args>
                                                            <arg evaluator="xml" expression="//Inv_FecIni/text()"/>
                                                            <arg evaluator="xml" expression="//Inv_FecVen/text()"/>
                                                            <arg evaluator="xml" expression="//Inv_Cuenta/text()"/>
                                                            <arg evaluator="xml" expression="//Inv_Gat"/>
                                                            <arg evaluator="xml" expression="//Inv_GatRea"/>
                                                            <arg evaluator="xml" expression="//Plazo"/>
                                                            <arg evaluator="xml" expression="get-property('operation','intBru')"/>
                                                            <arg evaluator="xml" expression="//Inv_IntNet"/>
                                                            <arg evaluator="xml" expression="//Inv_ISRTot"/>
                                                            <arg evaluator="xml" expression="//Inv_Total"/>
                                                        </args>
                                                    </payloadFactory>
                                                    <!-- Llamamos al micro-servicio para calcular vencimiento y redondear propiedades -->
                                                    <call blocking="true">
                                                        <endpoint>
                                                            <http method="post" uri-template="http://localhost:9090/inversiones/detalle"/>
                                                        </endpoint>
                                                    </call>
                                                    <respond/>
                                                </then>
                                                <else>
                                                    <filter xpath="get-property('operation','contador') = get-property('operation','totalInv')">
                                                        <then>
                                                            <log level="custom">
                                                                <property name="switchlog" value="CASO: No se encontraron coincidencias..."/>
                                                            </log>
                                                            <!-- Payload en caso de numero de inversion no valido -->
                                                            <property name="HTTP_SC" scope="axis2" type="STRING" value="409"/>
                                                            <payloadFactory media-type="json">
                                                                <format>
                                                                {
						                                        	"Error": {
						                                        		"Err_Codigo": 409,
						                                        		"Err_Mensaj": "Numero de inversion invalido"
						                                        	}
						                                        }
                                                                </format>
                                                                <args/>
                                                            </payloadFactory>
                                                            <respond/>
                                                        </then>
                                                        <else/>
                                                    </filter>
                                                </else>
                                            </filter>
                                        </sequence>
                                    </foreach>
                                </then>
                                <else>
                                    <log level="custom">
                                        <property name="switchlog" value="CASO: Error en la segunda llamada..."/>
                                    </log>
                                    <property name="HTTP_SC" scope="axis2" type="STRING" value="500"/>
                                    <payloadFactory media-type="json">
                                        <format>
                                        {
                                        	"Error": {
                                        		"Err_Codigo": 500,
                                        		"Err_Mensaj": "Error!"
                                        	}
                                        }
                                        </format>
                                        <args/>
                                    </payloadFactory>
                                    <respond/>
                                </else>
                            </filter>
                        </default>
                    </switch>
                </then>
                <else>
                    <log level="custom">
                        <property name="switchlog" value="CASO: Error en la primera llamada..."/>
                    </log>
                    <property name="HTTP_SC" scope="axis2" type="STRING" value="500"/>
                    <payloadFactory media-type="json">
                        <format>
                        {
                        	"Error": {
                        		"Err_Codigo": 500,
                        		"Err_Mensaj": "Error!"
                        	}
                        }
                        </format>
                        <args/>
                    </payloadFactory>
                    <respond/>
                </else>
            </filter>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </target>
</proxy>
