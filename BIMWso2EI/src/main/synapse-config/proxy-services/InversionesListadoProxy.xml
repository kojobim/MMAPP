<?xml version="1.0" encoding="UTF-8"?>
<proxy name="InversionesListadoProxy" startOnLoad="true" transports="http https" xmlns="http://ws.apache.org/ns/synapse">
    <target>
        <inSequence>
            <log level="full"/>
            <property expression="json-eval($.InversionesListadoProxy.tipConsul)" name="tipConsul" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.numTransac)" name="numTransac" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.transaccio)" name="transaccio" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.usuario)" name="usuario" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.fechaSis)" name="fechaSis" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.sucOrigen)" name="sucOrigen" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.sucDestino)" name="sucDestino" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.modulo)" name="modulo" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.bitUsuari)" name="bitUsuari" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.bitFecha)" name="bitFecha" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.bitTipOpe)" name="bitTipOpe" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.bitMonto)" name="bitMonto" scope="default" type="DOUBLE"/>
            <property expression="json-eval($.InversionesListadoProxy.bitPriRef)" name="bitPriRef" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.bitDireIP)" name="bitDireIP" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.invClient)" name="invClient" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.invMoneda)" name="invMoneda" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.invNumero)" name="invNumero" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.invUsuari)" name="invUsuari" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.page)" name="page" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.per_page)" name="per_page" scope="default" type="STRING"/>
            <property expression="json-eval($.InversionesListadoProxy.filter_by)" name="filter_by" scope="default" type="STRING"/>
            <enrich>
                <source clone="true" type="body"/>
                <target property="PAYLOAD_ORIGINAL" type="property"/>
            </enrich>
            <log level="custom">
                <property expression="get-property('PAYLOAD_ORIGINAL')" name="Payload Original..."/>
                <property expression="json-eval($.)" name="Payload Respuesta..."/>
            </log>
            <payloadFactory media-type="xml">
                <format>
                    <bitacoraCreacionOp>
                        <Bit_Usuari>$1</Bit_Usuari>
                        <Bit_Fecha>$2</Bit_Fecha>
                        <Bit_NumTra/>
                        <Bit_TipOpe>$3</Bit_TipOpe>
                        <Bit_CueOri/>
                        <Bit_CueDes/>
                        <Bit_Monto>$4</Bit_Monto>
                        <Bit_PriRef>$5</Bit_PriRef>
                        <Bit_SegRef/>
                        <Bit_DireIP>$6</Bit_DireIP>
                        <NumTransac>$7</NumTransac>
                        <Transaccio>$8</Transaccio>
                        <Usuario>$9</Usuario>
                        <FechaSis>$10</FechaSis>
                        <SucOrigen>$11</SucOrigen>
                        <SucDestino>$12</SucDestino>
                        <Modulo>$13</Modulo>
                    </bitacoraCreacionOp>
                </format>
                <args>
                    <arg evaluator="xml" expression="$ctx:bitUsuari"/>
                    <arg evaluator="xml" expression="$ctx:bitFecha"/>
                    <arg evaluator="xml" expression="$ctx:bitTipOpe"/>
                    <arg evaluator="xml" expression="$ctx:bitMonto"/>
                    <arg evaluator="xml" expression="$ctx:bitPriRef"/>
                    <arg evaluator="xml" expression="$ctx:bitDireIP"/>
                    <arg evaluator="xml" expression="$ctx:numTransac"/>
                    <arg evaluator="xml" expression="$ctx:transaccio"/>
                    <arg evaluator="xml" expression="$ctx:usuario"/>
                    <arg evaluator="xml" expression="$ctx:fechaSis"/>
                    <arg evaluator="xml" expression="$ctx:sucOrigen"/>
                    <arg evaluator="xml" expression="$ctx:sucDestino"/>
                    <arg evaluator="xml" expression="$ctx:modulo"/>
                </args>
            </payloadFactory>
            <call blocking="true">
                <endpoint>
                    <address uri="http://localhost:8280/services/BitacoraServicio/bitacoraCreacionOp"/>
                </endpoint>
            </call>
            <enrich>
                <source clone="true" type="body"/>
                <target property="PAYLOAD_PRIMERA_LLAMADA" type="property"/>
            </enrich>
            <filter regex="200" source="get-property('axis2', 'HTTP_SC')">
                <then>
                    <log level="custom">
                        <property expression="get-property('PAYLOAD_PRIMERA_LLAMADA')" name="Payload de la primera llamada..."/>
                    </log>
                    <clone>
                        <target>
                            <sequence>
                                <payloadFactory media-type="xml">
                                    <format>
                                        <inversionesObtenerOp>
                                            <Inv_Client>$1</Inv_Client>
                                            <Inv_Moneda>$2</Inv_Moneda>
                                            <NumTransac/>
                                            <Transaccio>$3</Transaccio>
                                            <Usuario>$4</Usuario>
                                            <FechaSis>$5</FechaSis>
                                            <SucOrigen>$6</SucOrigen>
                                            <SucDestino>$7</SucDestino>
                                            <Modulo>$8</Modulo>
                                        </inversionesObtenerOp>
                                    </format>
                                    <args>
                                        <arg evaluator="xml" expression="$ctx:invClient"/>
                                        <arg evaluator="xml" expression="$ctx:invMoneda"/>
                                        <arg evaluator="xml" expression="$ctx:transaccio"/>
                                        <arg evaluator="xml" expression="$ctx:usuario"/>
                                        <arg evaluator="xml" expression="$ctx:fechaSis"/>
                                        <arg evaluator="xml" expression="$ctx:sucOrigen"/>
                                        <arg evaluator="xml" expression="$ctx:sucDestino"/>
                                        <arg evaluator="xml" expression="$ctx:modulo"/>
                                    </args>
                                </payloadFactory>
                                <call>
                                    <endpoint>
                                        <address uri="http://localhost:8280/services/InversionesServicio/inversionesObtenerOp"/>
                                    </endpoint>
                                </call>
                            </sequence>
                        </target>
                        <target>
                            <sequence>
                                <payloadFactory media-type="xml">
                                    <format>
                                        <inversionesPagareNumeroUsuarioObtenerOp>
                                            <Inv_Numero>$1</Inv_Numero>
                                            <Inv_Usuari>$2</Inv_Usuari>
                                            <Tip_Consul>$3</Tip_Consul>
                                            <NumTransac/>
                                            <Transaccio>$4</Transaccio>
                                            <Usuario>$5</Usuario>
                                            <FechaSis>$6</FechaSis>
                                            <SucOrigen>$7</SucOrigen>
                                            <SucDestino>$8</SucDestino>
                                            <Modulo>$9</Modulo>
                                        </inversionesPagareNumeroUsuarioObtenerOp>
                                    </format>
                                    <args>
                                        <arg evaluator="xml" expression="$ctx:invNumero"/>
                                        <arg evaluator="xml" expression="$ctx:invUsuari"/>
                                        <arg evaluator="xml" expression="$ctx:tipConsul"/>
                                        <arg evaluator="xml" expression="$ctx:transaccio"/>
                                        <arg evaluator="xml" expression="$ctx:usuario"/>
                                        <arg evaluator="xml" expression="$ctx:fechaSis"/>
                                        <arg evaluator="xml" expression="$ctx:sucOrigen"/>
                                        <arg evaluator="xml" expression="$ctx:sucDestino"/>
                                        <arg evaluator="xml" expression="$ctx:modulo"/>
                                    </args>
                                </payloadFactory>
                                <call>
                                    <endpoint>
                                        <address uri="http://localhost:8280/services/InversionesServicio/inversionesPagareNumeroUsuarioObtenerOp"/>
                                    </endpoint>
                                </call>
                            </sequence>
                        </target>
                    </clone>
                    <property name="resultado" scope="default">
                        <inversiones/>
                    </property>
                    <aggregate>
                        <completeCondition>
                            <messageCount max="-1" min="-1"/>
                        </completeCondition>
                        <onComplete enclosingElementProperty="resultado" expression="$body/*[1]/inversiones/inversion">
                            <log level="custom">
                                <property expression="json-eval($.)" name="Payload Final..."/>
                            </log>
                            <call blocking="true">
                                <endpoint>
                                    <http method="post" uri-template="http://localhost:9090/filtroInversiones"/>
                                </endpoint>
                            </call>
                            <respond/>
                        </onComplete>
                    </aggregate>
                </then>
                <else>
                    <log level="custom">
                        <property name="switchlog" value="CASO: Error en la primera llamada..."/>
                    </log>
                    <property name="HTTP_SC" scope="axis2" type="STRING" value="500"/>
                    <payloadFactory media-type="xml">
                        <format>
                            <Error>
                                <Err_Codigo>500</Err_Codigo>
                                <Err_Mensaj>ERROR!</Err_Mensaj>
                            </Error>
                        </format>
                        <args/>
                    </payloadFactory>
                    <property name="messageType" scope="axis2" type="STRING" value="application/json"/>
                    <respond/>
                </else>
            </filter>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </target>
</proxy>
